name: Deploy to neocities

# Only run on changes to main. Use main or master depending on whatever your default branch is called.
on:
  push:
    branches:
      - master

concurrency: # Prevent concurrent deploys doing strange things
  group: deploy-to-neocities
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '2.7'

    - name: Install Bundler
      run: gem install bundler -v 2.4.22

    - name: Install dependencies
      run: bundle install

    - name: Build static site
      run: bundle exec jekyll build

    - name: List _site directory
      run: ls -la _site

    - name: Deploy to neocities
      uses: bcomnes/deploy-to-neocities@v2.0.2
      with:
        api_token: ${{ secrets.NEOCITIES_API_KEY }} # Uses API key from Neocities
        cleanup: false
        dist_dir: _site

    - name: Check for new posts
      id: check_new_posts
      run: |
        if git diff --name-only HEAD^ HEAD | grep -q '^_posts/'; then
          echo "new_post=true" >> $GITHUB_ENV
        else
          echo "new_post=false" >> $GITHUB_ENV
        fi
    
    - name: Post to Mastodon
      env:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      run: |
        echo "$SSH_PRIVATE_KEY" > private_key
        chmod 600 private_key
        ssh -i private_key -o StrictHostKeyChecking=no root@67.205.188.225 'python3 /masto-poast/poast.py "New post published: ${{ github.event.head_commit.message }}"'